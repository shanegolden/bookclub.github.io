<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Book Club Home</title>
<link rel="stylesheet" href="./components/navbar.css" />
<style>
  body { font-family: Arial, sans-serif; background: #f5f6fa; margin:0; padding:0; padding-top:80px; }
  .container { max-width:700px; margin:2rem auto; padding:1rem; background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.08); }
  .submission-card { display:flex; flex-direction:column; align-items:center; margin:1rem 0; background:#f0f4f8; padding:1rem; border-radius:8px; }
  .submission-card img.book-cover { width:150px; height:220px; object-fit:cover; border-radius:5px; }
  .book-info { text-align:center; margin-top:0.5rem; }
  .winner-display { margin-top:1rem; font-weight:bold; font-size:1.05rem; color:#2a7a2a; min-height:120px; display:flex; align-items:center; justify-content:center; }
  .muted { color:#666; font-size:0.95rem; }
</style>
</head>
<body>

<div id="navbar"></div>

<div class="container">
  <h2>Most Recent Winning Book</h2>
  <div id="winnerDisplay" class="winner-display">Loading...</div>
  <p id="debugHint" class="muted" style="text-align:center; margin-top:0.5rem;">If nothing appears, open the browser console for debugging info.</p>
</div>

<script type="module">
/* load the navbar if you have it */
import { loadNavbar } from './components/load-navbar.js';
try { loadNavbar("Home", false); } catch(e){ console.warn("load-navbar failed", e); }

/* Firebase imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, limit, onSnapshot, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

/* Your firebase config - keep yours here */
const firebaseConfig = { 
  apiKey:"AIzaSyARFfiXUa27jTt2nfuStSGZL4HCCp5oPx0", 
  authDomain:"book-club-f42b1.firebaseapp.com", 
  projectId:"book-club-f42b1", 
  storageBucket:"book-club-f42b1.appspot.com", 
  messagingSenderId:"85630091573", 
  appId:"1:85630091573:web:427077f1351140fc278c7c" 
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const winnerContainer = document.getElementById("winnerDisplay");

let currentPeriod = null;
let booksUnsubscribe = null;

/* Helper to render text or card */
function renderText(text) {
  winnerContainer.innerHTML = `<div class="muted">${text}</div>`;
}

function renderWinnerCard(winner, details) {
  winnerContainer.innerHTML = `
    <div class="submission-card" role="region" aria-label="winning book">
      <img src="${winner.coverUrl || 'https://via.placeholder.com/150x220'}" class="book-cover" alt="cover for ${escapeHtml(winner.title)}"/>
      <div class="book-info">
        <h3>${escapeHtml(winner.title)}</h3>
        <p><strong>Author:</strong> ${escapeHtml(winner.author || "Unknown")}</p>
        <p><strong>Year Published:</strong> ${escapeHtml(details.year || "Unknown")}</p>
        <p><strong>Pages:</strong> ${escapeHtml(details.pages || "Unknown")}</p>
        <p style="font-size:0.9rem;"><strong>Description:</strong> ${escapeHtml(details.description || "No description available")}</p>
        <p style="margin-top:0.5rem;"><strong>Votes:</strong> ${winner.votes?.length || 0}</p>
      </div>
    </div>
  `;
}

/* escape helper to avoid accidental HTML injection in the UI */
function escapeHtml(str) {
  if (str === null || str === undefined) return "";
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

/* Safely fetch OpenLibrary details for a book title+author */
async function fetchOpenLibraryDetails(title, author) {
  const fallback = { year: "Unknown", pages: "Unknown", description: "No description available" };
  if (!title && !author) return fallback;
  try {
    const url = `https://openlibrary.org/search.json?title=${encodeURIComponent(title || "")}&author=${encodeURIComponent(author || "")}&limit=1`;
    const res = await fetch(url);
    if (!res.ok) {
      console.warn("OpenLibrary non-ok response", res.status);
      return fallback;
    }
    const data = await res.json();
    if (data.docs && data.docs.length > 0) {
      const doc = data.docs[0];
      return {
        year: doc.first_publish_year || "Unknown",
        pages: doc.number_of_pages_median || "Unknown",
        description: doc.subtitle || (Array.isArray(doc.text) ? doc.text.slice(0,200).join(" ") : (doc.text || "No description available"))
      };
    } else {
      return fallback;
    }
  } catch (err) {
    console.error("OpenLibrary fetch error", err);
    return fallback;
  }
}

/* Called whenever the period changes. It detaches previous books listener and attaches a new one. */
function listenToBooksForPeriod(period) {
  // detach old listener if present
  if (booksUnsubscribe) {
    try { booksUnsubscribe(); } catch(e) { console.warn("error unsubscribing books listener", e); }
    booksUnsubscribe = null;
  }

  if (!period) {
    renderText("No submission periods yet.");
    console.info("No current period");
    return;
  }

  // query books where periodId == period.id
  const booksRef = collection(db, "books");
  const q = query(booksRef, where("periodId", "==", period.id));

  booksUnsubscribe = onSnapshot(q, async snapshot => {
    console.info("books snapshot received, docs:", snapshot.docs.length);
    const books = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    if (books.length === 0 || books.every(b => !b.votes?.length)) {
      renderText("No winner yet");
      return;
    }

    // pick highest votes
    const winner = books.sort((a,b) => (b.votes?.length || 0) - (a.votes?.length || 0))[0];
    renderText("Loading book details...");

    const details = await fetchOpenLibraryDetails(winner.title, winner.author);
    renderWinnerCard(winner, details);
    console.info("Displayed winner:", winner.title, "votes:", winner.votes?.length || 0);
  }, err => {
    console.error("books onSnapshot error", err);
    renderText("Error loading books");
  });
}

/* Listen to submissionPeriods in real time and pick latest period defensively */
function listenToLatestPeriod() {
  const periodsRef = collection(db, "submissionPeriods");

  // use onSnapshot without forcing an order so we can be resilient if createdAt is missing
  const unsubscribe = onSnapshot(periodsRef, snapshot => {
    console.info("periods snapshot received, count:", snapshot.docs.length);
    if (!snapshot.docs.length) {
      currentPeriod = null;
      listenToBooksForPeriod(null);
      return;
    }

    // Try to find latest by createdAt if available, otherwise fall back to last doc in snapshot
    const periods = snapshot.docs.map(d => ({ id: d.id, ...d.data(), _snapshotIndex: d._key?.path?.segments?.slice?.(-1)?.[0] ?? null }));

    let latest = null;
    const withCreated = periods.filter(p => p.createdAt && typeof p.createdAt.toMillis === "function");
    if (withCreated.length) {
      latest = withCreated.sort((a,b) => b.createdAt.toMillis() - a.createdAt.toMillis())[0];
      console.info("selected latest period by createdAt:", latest.id);
    } else {
      // fallback: choose the last doc in snapshot order
      const lastDoc = snapshot.docs[snapshot.docs.length-1];
      latest = { id: lastDoc.id, ...lastDoc.data() };
      console.info("selected latest period by snapshot fallback:", latest.id);
    }

    // if unchanged, do nothing
    if (currentPeriod && currentPeriod.id === latest.id) {
      console.info("period unchanged:", latest.id);
      return;
    }

    currentPeriod = latest;
    console.info("currentPeriod set to", currentPeriod.id, currentPeriod);
    listenToBooksForPeriod(currentPeriod);
  }, err => {
    console.error("periods onSnapshot error", err);
    renderText("Error loading submission periods");
  });

  return unsubscribe;
}

/* init on load */
window.addEventListener("DOMContentLoaded", () => {
  renderText("Loading...");
  try {
    listenToLatestPeriod();
  } catch (err) {
    console.error("init error", err);
    renderText("Initialization error, check console");
  }
});
</script>

</body>
</html>
