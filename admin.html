<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Book Club Admin Panel</title>
<link rel="stylesheet" href="navbar.css" />
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f6f8; margin: 0; padding: 0; }
  main { padding: 2rem; max-width: 1000px; margin: auto; margin-top: 80px; } /* leave space for navbar */
  h2 { color: #1f2937; margin-top: 2rem; }
  .btn { background: #4f46e5; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin: 0.2rem; }
  .btn:hover { background: #6366f1; }
  input { padding: 0.5rem; border-radius: 6px; border: 1px solid #d1d5db; margin-right: 0.5rem; margin-bottom: 1rem; }
  .period-card, .submission-card, .member-card { background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
  .submission-card, .member-card { display: flex; gap: 1rem; align-items: center; transition: transform 0.2s ease; }
  .submission-card:hover, .member-card:hover { transform: translateY(-2px); }
  .book-cover { width: 120px; height: 180px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
  .book-info { flex-grow: 1; }
  .book-info h3 { margin: 0; font-size: 1.2rem; }
  .book-info p { margin: 0.3rem 0; color: #4b5563; }
</style>
</head>
<body>

<!-- Navbar will be dynamically inserted -->
<script type="module">
  import { loadNavbar } from './navbar.js';
  // Pass "Admin" to indicate this page is active, true = show admin menu items
  loadNavbar("Admin", true);
</script>

<main>
  <!-- Member Approvals -->
  <h2>Approve or Deny Members</h2>
  <div id="memberRequestsList"></div>

  <!-- Submission Period Control -->
  <h2>Manage Submission Periods</h2>
  <input id="periodName" placeholder="Enter submission period name" />
  <button id="toggleSubmission" class="btn">Start Book Submissions</button>
  <div id="periodMessage"></div>

  <!-- Submission Periods List -->
  <div id="submissionPeriodsList"></div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
  import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyARFfiXUa27jTt2nfuStSGZL4HCCp5oPx0",
    authDomain: "book-club-f42b1.firebaseapp.com",
    projectId: "book-club-f42b1",
    storageBucket: "book-club-f42b1.appspot.com",
    messagingSenderId: "85630091573",
    appId: "1:85630091573:web:427077f1351140fc278c7c"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let submissionOpen = false;

  async function loadMemberRequests() {
    const container = document.getElementById("memberRequestsList");
    container.innerHTML = "";
    const membersSnap = await getDocs(query(collection(db,"members"), where("approved","==",false)));
    membersSnap.forEach(docSnap => {
      const member = docSnap.data();
      const card = document.createElement("div");
      card.className = "member-card";
      card.innerHTML = `
        <div class="book-info">
          <h3>${member.name || member.email}</h3>
          <p>${member.email}</p>
        </div>
        <button class="btn approve">Approve</button>
        <button class="btn deny">Deny</button>
      `;
      container.appendChild(card);

      card.querySelector(".approve").addEventListener("click", async () => {
        await updateDoc(doc(db,"members",docSnap.id), { approved:true });
        loadMemberRequests();
      });

      card.querySelector(".deny").addEventListener("click", async () => {
        await deleteDoc(doc(db,"members",docSnap.id));
        loadMemberRequests();
      });
    });
  }

  async function loadSubmissionPeriods() {
    const periodsSnap = await getDocs(collection(db, "submissionPeriods"));
    const container = document.getElementById("submissionPeriodsList");
    container.innerHTML = "";

    const sortedPeriods = periodsSnap.docs.sort((a,b) => b.data().createdAt?.toMillis() - a.data().createdAt?.toMillis());
    
    sortedPeriods.forEach(async docSnap => {
      const period = docSnap.data();
      const card = document.createElement("div");
      card.className = "period-card";
      card.innerHTML = `
        <h3>${period.name || 'Unnamed Period'} ${period.active ? '(Open)' : '(Closed)'} ${period.votingActive ? '(Voting Active)' : ''}</h3>
        <button class="btn seeSubmissions">See Submissions</button>
        <button class="btn editPeriod">Edit Name</button>
        <button class="btn deletePeriod">Delete Period</button>
      `;
      container.appendChild(card);

      if(!period.active){
        const voteBtn = document.createElement("button");
        voteBtn.className = "btn startVoting";
        voteBtn.innerText = period.votingActive ? "End Voting" : "Start Voting";
        card.appendChild(voteBtn);
        voteBtn.addEventListener("click", async () => {
          await updateDoc(doc(db,"submissionPeriods",docSnap.id), { votingActive: !period.votingActive, voters: [] });
          loadSubmissionPeriods();
        });
      }

      card.querySelector(".seeSubmissions").addEventListener("click", async () => {
        const submissionsListDiv = document.createElement("div");
        submissionsListDiv.style.marginTop = "1rem";
        card.appendChild(submissionsListDiv);
        submissionsListDiv.innerHTML = "";

        const submissionsSnap = await getDocs(query(collection(db,"books"), where("periodId","==",docSnap.id)));

        const books = [];
        for(const bDoc of submissionsSnap.docs){
          const b = bDoc.data();
          const bookCard = document.createElement("div");
          bookCard.className = "submission-card";
          bookCard.innerHTML = `
            <img src="${b.coverUrl || 'https://via.placeholder.com/120x180'}" class="book-cover"/>
            <div class="book-info">
              <h3>${b.title}</h3>
              <p>${b.author}</p>
              <p>Votes: ${b.votes?.length || 0}</p>
            </div>
          `;
          submissionsListDiv.appendChild(bookCard);
          books.push({...b, id:bDoc.id});
        }
      });

      card.querySelector(".editPeriod").addEventListener("click", async () => {
        const newName = prompt("Enter new period name", period.name);
        if(newName){
          await updateDoc(doc(db,"submissionPeriods",docSnap.id),{name:newName});
          loadSubmissionPeriods();
        }
      });

      card.querySelector(".deletePeriod").addEventListener("click", async () => {
        await deleteDoc(doc(db,"submissionPeriods",docSnap.id));
        loadSubmissionPeriods();
      });
    });
  }

  document.getElementById("toggleSubmission").addEventListener("click", async () => {
    const nameInput = document.getElementById("periodName").value.trim();
    const periodsRef = collection(db,"submissionPeriods");

    const periodsSnap = await getDocs(periodsRef);
    for(const d of periodsSnap.docs){
      if(d.data().active) await updateDoc(doc(db,"submissionPeriods",d.id),{active:false});
    }

    if(!submissionOpen){
      if(!nameInput){ document.getElementById("periodMessage").innerText="Enter a name for the period."; return; }
      await addDoc(periodsRef,{name:nameInput, active:true, createdAt:serverTimestamp()});
      submissionOpen=true;
      document.getElementById("toggleSubmission").innerText="Close Book Submissions";
      document.getElementById("periodName").value="";
    } else {
      submissionOpen=false;
      document.getElementById("toggleSubmission").innerText="Start Book Submissions";
    }

    loadSubmissionPeriods();
  });

  onAuthStateChanged(auth,user=>{
    if(!user) window.location.href="login.html";
    else { currentUser=user; loadMemberRequests(); loadSubmissionPeriods(); }
  });
</script>
</body>
</html>
